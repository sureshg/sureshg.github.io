<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Trace Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            font-size: 14px;
            color: #24292f;
            background: #ffffff;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #f6f8fa;
            border-bottom: 1px solid #d1d9e0;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            color: #0969da;
        }

        .btn {
            background: #f6f8fa;
            border: 1px solid #d1d9e0;
            border-radius: 6px;
            color: #24292f;
            cursor: pointer;
            font-size: 14px;
            padding: 6px 12px;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .btn:hover:not(:disabled) {
            background: #f3f4f6;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #2da44e;
            border-color: #2da44e;
            color: #ffffff;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2c974b;
        }

        .url-input {
            padding: 6px 12px;
            border: 1px solid #d1d9e0;
            border-radius: 6px;
            font-size: 14px;
            width: 300px;
        }

        .stats {
            margin-left: auto;
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: #656d76;
        }

        .loading {
            color: #0969da;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #e1e4e8;
            border-top: 2px solid #0969da;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(90deg, #2da44e, #26d045);
            border-radius: 6px;
            transition: width 0.3s ease;
            opacity: 0.8;
        }

        .progress-text {
            position: relative;
            z-index: 1;
            color: white;
            font-weight: 500;
        }

        .pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .main {
            display: flex;
            flex: 1;
            min-height: 0;
        }

        .sidebar {
            width: 320px;
            border-right: 1px solid #d1d9e0;
            background: #f6f8fa;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid #d1d9e0;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d9e0;
            border-radius: 6px;
            background: #ffffff;
            font-size: 14px;
        }

        .trace-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .trace-item {
            background: #ffffff;
            border: 1px solid #d1d9e0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .trace-item:hover {
            border-color: #fd8c73;
        }

        .trace-item.selected {
            border-color: #fd8c73;
            background-color: #fff8f6;
        }

        .trace-close {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            border: none;
            background: #f3f4f6;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            color: #656d76;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .trace-item:hover .trace-close {
            display: flex;
        }

        .trace-close:hover {
            background: #e1e4e8;
            color: #24292f;
        }

        .trace-id {
            font-family: monospace;
            font-size: 11px;
            color: #656d76;
            margin-bottom: 4px;
            word-break: break-all;
            padding-right: 24px;
        }

        .trace-name {
            font-weight: 600;
            color: #0969da;
            margin-bottom: 4px;
            padding-right: 24px;
        }

        .trace-info {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #656d76;
        }

        .trace-duration {
            font-weight: 600;
            color: #0969da;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .content-header {
            padding: 16px 24px;
            border-bottom: 1px solid #d1d9e0;
            background: #f6f8fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .trace-details {
            flex: 1;
            min-width: 0;
        }

        .trace-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .trace-subtitle {
            font-size: 12px;
            color: #656d76;
        }

        .trace-controls {
            display: flex;
            gap: 8px;
        }

        .expand-all-btn {
            font-size: 12px;
            padding: 4px 8px;
        }

        .clear-all-btn {
            font-size: 12px;
            padding: 4px 8px;
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
        }

        .clear-all-btn:hover:not(:disabled) {
            background: #ff5252;
        }

        .timeline-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        .timeline-header {
            height: 40px;
            background: #f6f8fa;
            border-bottom: 1px solid #d1d9e0;
            display: grid;
            grid-template-columns: 400px 1fr;
            align-items: center;
            font-size: 12px;
            color: #656d76;
            flex-shrink: 0;
        }

        .timeline-axis {
            position: relative;
            height: 100%;
            padding: 0 16px;
        }

        .axis-tick {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 1px;
            background: #e1e4e8;
        }

        .axis-label {
            position: absolute;
            bottom: 8px;
            font-size: 10px;
            transform: translateX(-50%);
        }

        .timeline-body {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .span-row {
            display: grid;
            grid-template-columns: 400px 1fr;
            min-height: 32px;
            border-bottom: 1px solid #f6f8fa;
            cursor: pointer;
            user-select: none;
        }

        .span-row:hover {
            background: #f6f8fa;
        }

        .span-label {
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 6px;
            border-right: 1px solid #d1d9e0;
            background: #ffffff;
        }

        .expand-btn {
            width: 16px;
            height: 16px;
            border: none;
            background: none;
            cursor: pointer;
            color: #656d76;
            font-size: 12px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .expand-btn:hover {
            background: #f3f4f6;
        }

        .span-info {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-width: 0;
        }

        .span-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 13px;
        }

        .span-duration-label {
            font-size: 11px;
            color: #7c3aed;
            font-family: monospace;
            font-weight: 600;
            margin-left: 8px;
            flex-shrink: 0;
        }

        .span-timeline {
            position: relative;
            padding: 8px 16px;
            min-width: 0;
        }

        .span-bar {
            height: 16px;
            border-radius: 4px;
            cursor: pointer;
            position: absolute;
            top: 8px;
            display: flex;
            align-items: center;
            color: white;
            font-size: 10px;
            font-weight: 500;
            overflow: hidden;
            transition: all 0.2s;
            min-width: 2px;
        }

        .span-bar:hover {
            filter: brightness(1.1);
            z-index: 10;
        }

        .span-duration {
            padding: 0 4px;
            font-size: 9px;
            opacity: 0.95;
            white-space: nowrap;
            overflow: hidden;
        }

        .tooltip {
            position: absolute;
            background: #24292f;
            color: #ffffff;
            padding: 12px;
            border-radius: 6px;
            font-size: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            pointer-events: none;
            max-width: 350px;
            line-height: 1.4;
        }

        .tooltip-row {
            margin-bottom: 4px;
            display: flex;
            gap: 8px;
        }

        .tooltip-row:last-child {
            margin-bottom: 0;
        }

        .tooltip-label {
            font-weight: 600;
            min-width: 60px;
        }

        .tooltip-value {
            font-family: monospace;
            background: rgba(255, 255, 255, 0.1);
            padding: 1px 4px;
            border-radius: 3px;
        }

        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #656d76;
            flex-direction: column;
            gap: 8px;
        }

        .hidden {
            display: none;
        }

        input[type="file"] {
            display: none;
        }

        .depth-0 {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .depth-1 {
            background: linear-gradient(135deg, #f093fb, #f5576c);
        }

        .depth-2 {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
        }

        .depth-3 {
            background: linear-gradient(135deg, #43e97b, #38f9d7);
        }

        .depth-4 {
            background: linear-gradient(135deg, #fa709a, #fee140);
        }

        .depth-5 {
            background: linear-gradient(135deg, #a8edea, #fed6e3);
            color: #24292f;
        }

        .depth-6 {
            background: linear-gradient(135deg, #ffecd2, #fcb69f);
            color: #24292f;
        }

        .depth-7 {
            background: linear-gradient(135deg, #ff9a9e, #fecfef);
            color: #24292f;
        }

        .depth-8 {
            background: linear-gradient(135deg, #a18cd1, #fbc2eb);
            color: #24292f;
        }

        .depth-default {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
        }

        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #2da44e;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            z-index: 1001;
            animation: slideIn 0.3s ease-out;
        }

        .notification.error {
            background: #da3633;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .footer {
            background: #f6f8fa;
            border-top: 1px solid #d1d9e0;
            padding: 8px 24px;
            font-size: 12px;
            color: #656d76;
            text-align: center;
            flex-shrink: 0;
        }

        .footer a {
            color: #0969da;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .kotlin-logo {
            background: linear-gradient(45deg, #7F52FF, #B146C2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
            font-size: 14px;
            margin-left: 4px;
            vertical-align: baseline;
        }
    </style>
</head>
<body>
<div class="header">
    <h1>🧭 Trace Viewer</h1>
    <label for="file-input" class="btn btn-primary" id="upload-btn">
        <span id="upload-text">Upload JSONL</span>
        <div class="progress-bar hidden" id="progress-bar"></div>
    </label>
    <input type="file" id="file-input" accept=".jsonl,.json" multiple>
    <button class="btn" id="demo-btn">Demo</button>
    <input type="text" class="url-input" id="url-input" placeholder="GitHub Gist URL or direct JSONL URL">
    <button class="btn" id="load-url-btn">Load URL</button>
    <div class="stats">
        <span id="loading-status" class="loading hidden">
            <div class="spinner"></div>
            Loading...
        </span>
        <span>📊 Traces: <span id="trace-count">0</span></span>
        <span>🔗 Spans: <span id="span-count">0</span></span>
    </div>
</div>

<div class="main">
    <div class="sidebar">
        <div class="sidebar-header">
            <input type="text" class="search-input" id="search" placeholder="🔍 Search traces and spans...">
        </div>
        <div class="trace-list" id="trace-list">
            <div class="empty-state">
                <div>✨ Upload JSONL files or try demo</div>
                <small>Supports multiple file selection</small>
            </div>
        </div>
    </div>

    <div class="content">
        <div class="content-header">
            <div class="trace-details">
                <div class="trace-title" id="trace-title">Select a trace</div>
                <div class="trace-subtitle" id="trace-subtitle"></div>
            </div>
            <div class="trace-controls">
                <button class="btn expand-all-btn" id="expand-all-btn">🔻 Collapse All</button>
                <button class="btn clear-all-btn" id="clear-all-btn">🧹 Clear All</button>
            </div>
        </div>
        <div class="timeline-container">
            <div class="timeline-header">
                <div style="padding: 0 16px; font-weight: 600;">📝 Span Name & Duration</div>
                <div class="timeline-axis" id="timeline-axis"></div>
            </div>
            <div class="timeline-body" id="timeline">
                <div class="empty-state">
                    <div>📈 No trace selected</div>
                    <small>Click a trace to view timeline</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="footer">
    Made for <a href="https://github.com/JetBrains/amper">Kotlin Amper</a> Build
    Traces •
    <a href="?url=https://gist.githubusercontent.com/sureshg/c0f0abd0a96b663000b18ca11d657fe9/raw">🔗 Share via URL</a>
</div>

<div class="tooltip hidden" id="tooltip"></div>

<script>
    'use strict';

    var DEMO_URL = 'https://gist.githubusercontent.com/sureshg/c0f0abd0a96b663000b18ca11d657fe9/raw';

    var state = {
        traces: [],
        selectedTrace: null,
        allExpanded: true,
        hoveredSpan: null,
        isProcessing: false
    };

    var elements = {
        fileInput: document.getElementById('file-input'),
        uploadBtn: document.getElementById('upload-btn'),
        uploadText: document.getElementById('upload-text'),
        progressBar: document.getElementById('progress-bar'),
        demoBtn: document.getElementById('demo-btn'),
        urlInput: document.getElementById('url-input'),
        loadUrlBtn: document.getElementById('load-url-btn'),
        loadingStatus: document.getElementById('loading-status'),
        expandAllBtn: document.getElementById('expand-all-btn'),
        clearAllBtn: document.getElementById('clear-all-btn'),
        searchInput: document.getElementById('search'),
        traceList: document.getElementById('trace-list'),
        traceTitle: document.getElementById('trace-title'),
        traceSubtitle: document.getElementById('trace-subtitle'),
        timeline: document.getElementById('timeline'),
        timelineAxis: document.getElementById('timeline-axis'),
        tooltip: document.getElementById('tooltip'),
        traceCount: document.getElementById('trace-count'),
        spanCount: document.getElementById('span-count')
    };

    function formatDuration(nanos) {
        if (!nanos) return '0ms';
        var ms = nanos / 1000000;
        if (ms < 1) return (nanos / 1000).toFixed(0) + 'μs';
        if (ms < 1000) return ms.toFixed(0) + 'ms';
        if (ms < 60000) return (ms / 1000).toFixed(1) + 's';
        return Math.floor(ms / 60000) + 'm' + ((ms % 60000) / 1000).toFixed(0) + 's';
    }

    function formatTime(nanos) {
        return new Date(Math.floor(nanos / 1000000)).toLocaleString();
    }

    function setLoadingState(loading) {
        state.isProcessing = loading;
        elements.loadingStatus.classList.toggle('hidden', !loading);
        elements.uploadBtn.disabled = loading;
        elements.demoBtn.disabled = loading;
        elements.loadUrlBtn.disabled = loading;
        elements.urlInput.disabled = loading;
        elements.fileInput.disabled = loading;
    }

    function updateProgressBar(progress, text) {
        if (progress >= 0) {
            elements.progressBar.style.width = progress + '%';
            elements.progressBar.classList.remove('hidden');
            elements.uploadText.textContent = text || 'Processing...';
            elements.uploadText.classList.add('progress-text');
        } else {
            elements.progressBar.classList.add('hidden');
            elements.uploadText.textContent = 'Upload JSONL';
            elements.uploadText.classList.remove('progress-text');
        }
    }

    function showNotification(message, isError) {
        var notification = document.createElement('div');
        notification.className = 'notification' + (isError ? ' error' : '');
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(function () {
            notification.remove();
        }, 3000);
    }

    function generateTraceName(trace) {
        var rootSpans = trace.rootSpans || [];
        if (rootSpans.length > 0) {
            var mainSpan = rootSpans[0];
            var name = mainSpan.name;
            if (name.indexOf('task :') === 0) return name;
            return trace.service + ': ' + name;
        }
        return trace.service !== 'unknown' ? trace.service : 'Trace ' + trace.traceId.substring(0, 8) + '...';
    }

    function parseJSONL(text, filename) {
        var lines = text.trim().split('\n').filter(function (line) {
            return line.trim();
        });
        var spans = [];

        lines.forEach(function (line, index) {
            try {
                var data = JSON.parse(line);
                if (data.resourceSpans) {
                    data.resourceSpans.forEach(function (rs) {
                        var service = 'unknown';
                        if (rs.resource && rs.resource.attributes) {
                            rs.resource.attributes.forEach(function (attr) {
                                if (attr.key === 'service.name' && attr.value && attr.value.stringValue) {
                                    service = attr.value.stringValue;
                                }
                            });
                        }

                        (rs.scopeSpans || []).forEach(function (ss) {
                            (ss.spans || []).forEach(function (span) {
                                var startTime = parseInt(span.startTimeUnixNano || 0);
                                var endTime = parseInt(span.endTimeUnixNano || 0);

                                spans.push({
                                    traceId: span.traceId,
                                    spanId: span.spanId,
                                    parentSpanId: span.parentSpanId || null,
                                    name: span.name || 'unnamed',
                                    service: service,
                                    startTime: startTime,
                                    endTime: endTime,
                                    duration: endTime - startTime,
                                    children: [],
                                    expanded: true,
                                    depth: 0,
                                    source: filename || 'unknown'
                                });
                            });
                        });
                    });
                }
            } catch (e) {
                console.warn('Parse error on line ' + (index + 1) + ':', e);
            }
        });

        return buildTraces(spans);
    }

    function buildTraces(spans) {
        var traceMap = {};

        spans.forEach(function (span) {
            if (!traceMap[span.traceId]) {
                traceMap[span.traceId] = [];
            }
            traceMap[span.traceId].push(span);
        });

        var traces = [];
        Object.keys(traceMap).forEach(function (traceId) {
            var traceSpans = traceMap[traceId];
            var spanMap = {};
            var rootSpans = [];

            traceSpans.forEach(function (span) {
                spanMap[span.spanId] = span;
            });

            traceSpans.forEach(function (span) {
                if (span.parentSpanId && spanMap[span.parentSpanId]) {
                    spanMap[span.parentSpanId].children.push(span);
                } else {
                    rootSpans.push(span);
                }
            });

            function setDepthAndSort(spans, depth) {
                spans.sort(function (a, b) {
                    return a.startTime - b.startTime;
                });
                spans.forEach(function (span) {
                    span.depth = depth;
                    if (span.children.length > 0) {
                        setDepthAndSort(span.children, depth + 1);
                    }
                });
            }

            setDepthAndSort(rootSpans, 0);

            var startTime = Math.min.apply(Math, traceSpans.map(function (s) {
                return s.startTime;
            }));
            var endTime = Math.max.apply(Math, traceSpans.map(function (s) {
                return s.endTime;
            }));

            var trace = {
                traceId: traceId,
                spans: traceSpans,
                rootSpans: rootSpans,
                startTime: startTime,
                endTime: endTime,
                duration: endTime - startTime,
                service: traceSpans[0] ? traceSpans[0].service : 'unknown'
            };

            trace.name = generateTraceName(trace);
            traces.push(trace);
        });

        traces.sort(function (a, b) {
            return b.endTime - a.endTime;
        });
        return traces;
    }

    function matchesSearch(trace, searchTerm) {
        if (!searchTerm) return true;
        searchTerm = searchTerm.toLowerCase();

        return trace.traceId.toLowerCase().indexOf(searchTerm) !== -1 ||
            trace.name.toLowerCase().indexOf(searchTerm) !== -1 ||
            trace.service.toLowerCase().indexOf(searchTerm) !== -1 ||
            trace.spans.some(function (span) {
                return span.name.toLowerCase().indexOf(searchTerm) !== -1;
            });
    }

    function renderTraceList() {
        if (state.traces.length === 0) {
            elements.traceList.innerHTML = '<div class="empty-state"><div>✨ No traces loaded</div><small>Upload files, load URL, or try demo</small></div>';
            return;
        }

        var searchTerm = elements.searchInput.value.trim();
        var filtered = state.traces.filter(function (trace) {
            return matchesSearch(trace, searchTerm);
        });

        elements.traceList.innerHTML = filtered.map(function (trace) {
            var isSelected = state.selectedTrace && state.selectedTrace.traceId === trace.traceId;
            return '<div class="trace-item ' + (isSelected ? 'selected' : '') + '" onclick="selectTrace(\'' + trace.traceId + '\')">' +
                '<button class="trace-close" onclick="removeTrace(event, \'' + trace.traceId + '\')">✕</button>' +
                '<div class="trace-name">' + trace.name + '</div>' +
                '<div class="trace-id">' + trace.traceId + '</div>' +
                '<div class="trace-info">' +
                '<span>🔗 ' + trace.spans.length + ' spans</span>' +
                '<span class="trace-duration">⏱️ ' + formatDuration(trace.duration) + '</span>' +
                '</div>' +
                '</div>';
        }).join('');
    }

    function selectTrace(traceId) {
        state.selectedTrace = state.traces.find(function (t) {
            return t.traceId === traceId;
        });
        renderTraceList();
        renderTimeline();
    }

    function removeTrace(event, traceId) {
        event.stopPropagation();
        state.traces = state.traces.filter(function (t) {
            return t.traceId !== traceId;
        });

        if (state.selectedTrace && state.selectedTrace.traceId === traceId) {
            state.selectedTrace = null;
            elements.timeline.innerHTML = '<div class="empty-state"><div>📈 No trace selected</div><small>Click a trace to view timeline</small></div>';
            elements.traceTitle.textContent = 'Select a trace';
            elements.traceSubtitle.textContent = '';
        }

        updateStats();
        renderTraceList();
    }

    function flattenSpans(spans) {
        var result = [];

        function traverse(spans) {
            spans.forEach(function (span) {
                result.push(span);
                if (span.expanded && span.children.length > 0) {
                    traverse(span.children);
                }
            });
        }

        traverse(spans);
        return result;
    }

    function renderTimelineAxis() {
        if (!state.selectedTrace) return;

        elements.timelineAxis.innerHTML = '';
        var duration = state.selectedTrace.duration;
        var containerWidth = elements.timelineAxis.offsetWidth - 32;

        for (var i = 0; i <= 6; i++) {
            var position = (i / 6) * containerWidth;
            var time = (i / 6) * duration;

            var tick = document.createElement('div');
            tick.className = 'axis-tick';
            tick.style.left = (16 + position) + 'px';

            var label = document.createElement('div');
            label.className = 'axis-label';
            label.style.left = (16 + position) + 'px';
            label.textContent = formatDuration(time);

            elements.timelineAxis.appendChild(tick);
            elements.timelineAxis.appendChild(label);
        }
    }

    function renderTimeline() {
        if (!state.selectedTrace) {
            elements.timeline.innerHTML = '<div class="empty-state"><div>📈 No trace selected</div><small>Click a trace to view timeline</small></div>';
            return;
        }

        elements.traceTitle.textContent = state.selectedTrace.name;
        elements.traceSubtitle.textContent = '🔗 ' + state.selectedTrace.spans.length + ' spans • ⏱️ ' +
            formatDuration(state.selectedTrace.duration) + ' • 📅 ' +
            formatTime(state.selectedTrace.startTime);

        renderTimelineAxis();

        var flatSpans = flattenSpans(state.selectedTrace.rootSpans);
        var duration = state.selectedTrace.duration || 1;
        var startTime = state.selectedTrace.startTime;

        elements.timeline.innerHTML = flatSpans.map(function (span) {
            var relativeStart = span.startTime - startTime;
            var leftPercent = Math.max(0, (relativeStart / duration) * 100);
            var widthPercent = Math.max(0.2, (span.duration / duration) * 100);

            var hasChildren = span.children.length > 0;
            var toggle = hasChildren ? (span.expanded ? '▼' : '▶') : '•';
            var depthClass = span.depth <= 8 ? 'depth-' + span.depth : 'depth-default';

            var durationText = formatDuration(span.duration);
            var showDuration = widthPercent > 8;

            return '<div class="span-row" ondblclick="copySpanOnDoubleClick(\'' + span.spanId + '\')">' +
                '<div class="span-label" style="padding-left: ' + (16 + span.depth * 16) + 'px">' +
                '<button class="expand-btn" onclick="toggleSpan(event, \'' + span.spanId + '\')" ' +
                (!hasChildren ? 'style="opacity: 0.3"' : '') + '>' + toggle + '</button>' +
                '<div class="span-info">' +
                '<div class="span-name" title="' + span.name + '">' + span.name + '</div>' +
                '<div class="span-duration-label">⏱️ ' + durationText + '</div>' +
                '</div>' +
                '</div>' +
                '<div class="span-timeline">' +
                '<div class="span-bar ' + depthClass + '" style="left: ' + leftPercent + '%; width: ' + widthPercent + '%;" ' +
                'onmouseenter="showTooltip(event, \'' + span.spanId + '\')" onmouseleave="hideTooltip()">' +
                (showDuration ? '<span class="span-duration">' + durationText + '</span>' : '') +
                '</div>' +
                '</div>' +
                '</div>';
        }).join('');
    }

    function copySpanOnDoubleClick(spanId) {
        if (!state.selectedTrace) return;

        var span = state.selectedTrace.spans.find(function (s) {
            return s.spanId === spanId;
        });

        if (!span) return;

        copySpanData(span);
    }

    function toggleSpan(event, spanId) {
        event.stopPropagation();

        function findSpan(spans) {
            for (var i = 0; i < spans.length; i++) {
                var span = spans[i];
                if (span.spanId === spanId) {
                    if (span.children.length > 0) {
                        span.expanded = !span.expanded;
                    }
                    return true;
                }
                if (findSpan(span.children)) return true;
            }
            return false;
        }

        if (state.selectedTrace) {
            findSpan(state.selectedTrace.rootSpans);
            renderTimeline();
        }
    }

    function toggleExpandAll() {
        if (!state.selectedTrace) return;

        state.allExpanded = !state.allExpanded;
        elements.expandAllBtn.textContent = state.allExpanded ? '🔻 Collapse All' : '🔺 Expand All';

        function setExpanded(spans, expanded) {
            spans.forEach(function (span) {
                if (span.children.length > 0) {
                    span.expanded = expanded;
                    setExpanded(span.children, expanded);
                }
            });
        }

        setExpanded(state.selectedTrace.rootSpans, state.allExpanded);
        renderTimeline();
    }

    function showTooltip(event, spanId) {
        if (!state.selectedTrace) return;

        var span = state.selectedTrace.spans.find(function (s) {
            return s.spanId === spanId;
        });
        if (!span) return;

        state.hoveredSpan = span;
        var relativeStart = span.startTime - state.selectedTrace.startTime;

        elements.tooltip.innerHTML =
            '<div class="tooltip-row"><span class="tooltip-label">📝 Name:</span><span class="tooltip-value">' + span.name + '</span></div>' +
            '<div class="tooltip-row"><span class="tooltip-label">⏱️ Duration:</span><span class="tooltip-value">' + formatDuration(span.duration) + '</span></div>' +
            '<div class="tooltip-row"><span class="tooltip-label">🚀 Start:</span><span class="tooltip-value">+' + formatDuration(relativeStart) + '</span></div>' +
            '<div class="tooltip-row"><span class="tooltip-label">🏢 Service:</span><span class="tooltip-value">' + span.service + '</span></div>' +
            '<div class="tooltip-row"><span class="tooltip-label">🔗 Span:</span><span class="tooltip-value">' + span.spanId.substring(0, 16) + '...</span></div>' +
            '<div style="margin-top: 8px; font-size: 11px; opacity: 0.8;">💡 Double-click to copy</div>';

        var left = event.pageX + 10;
        var top = event.pageY + 10;

        elements.tooltip.style.left = left + 'px';
        elements.tooltip.style.top = top + 'px';
        elements.tooltip.classList.remove('hidden');
    }

    function hideTooltip() {
        elements.tooltip.classList.add('hidden');
    }

    function copySpanData(span) {
        if (!span) {
            if (!state.hoveredSpan) {
                showNotification('❌ No span data to copy. Hover over a span first.', true);
                return;
            }
            span = state.hoveredSpan;
        }

        var relativeStart = span.startTime - state.selectedTrace.startTime;
        var text = '📝 Name: ' + span.name +
            '\n⏱️ Duration: ' + formatDuration(span.duration) +
            '\n🚀 Start: +' + formatDuration(relativeStart) +
            '\n🏢 Service: ' + span.service +
            '\n🔗 Span ID: ' + span.spanId +
            '\n📊 Trace ID: ' + span.traceId;

        if (navigator.clipboard) {
            navigator.clipboard.writeText(text).then(function () {
                showNotification('📋 Span "' + span.spanId.substring(0, 8) + '..." copied to clipboard!');
            }).catch(function () {
                showNotification('❌ Failed to copy to clipboard', true);
            });
        } else {
            showNotification('❌ Clipboard not supported', true);
        }
    }

    function clearAll() {
        // Reset the file input completely
        elements.fileInput.value = '';
        elements.fileInput.type = '';
        elements.fileInput.type = 'file';

        state.traces = [];
        state.selectedTrace = null;
        state.hoveredSpan = null;
        state.isProcessing = false;

        elements.urlInput.value = '';
        elements.searchInput.value = '';

        updateProgressBar(-1);
        updateStats();
        renderTraceList();

        elements.timeline.innerHTML = '<div class="empty-state"><div>📈 No trace selected</div><small>Click a trace to view timeline</small></div>';
        elements.traceTitle.textContent = 'Select a trace';
        elements.traceSubtitle.textContent = '';
        elements.expandAllBtn.textContent = '🔻 Collapse All';
        state.allExpanded = true;

        showNotification('🧹 All traces cleared');
    }

    function updateStats() {
        var totalSpans = state.traces.reduce(function (sum, trace) {
            return sum + trace.spans.length;
        }, 0);
        elements.traceCount.textContent = state.traces.length;
        elements.spanCount.textContent = totalSpans;
    }

    function loadFromUrl(url) {
        var targetUrl = url || elements.urlInput.value.trim();
        if (!targetUrl) {
            showNotification('❌ Please enter a URL', true);
            return;
        }

        var fetchUrl = targetUrl;
        if (targetUrl.indexOf('gist.github.com') !== -1) {
            var match = targetUrl.match(/gist\.github\.com\/(?:[\w-]+\/)?([a-f0-9]+)/);
            if (match) {
                fetchUrl = 'https://gist.githubusercontent.com/' + match[1] + '/raw/';
            }
        }

        setLoadingState(true);
        fetch(fetchUrl)
            .then(function (response) {
                if (!response.ok) throw new Error('HTTP ' + response.status);
                return response.text();
            })
            .then(function (text) {
                var newTraces = parseJSONL(text, url ? 'Demo' : 'URL: ' + targetUrl);
                if (newTraces.length === 0) {
                    showNotification('❌ No valid traces found in the URL', true);
                    return;
                }

                state.traces = state.traces.concat(newTraces);
                state.traces.sort(function (a, b) {
                    return b.endTime - a.endTime;
                });
                updateStats();
                renderTraceList();
                showNotification('✅ Loaded ' + newTraces.length + ' traces' + (url ? ' from demo' : ' from URL'));
            })
            .catch(function (error) {
                showNotification('❌ Failed to load' + (url ? ' demo' : ' from URL') + ': ' + error.message, true);
            })
            .finally(function () {
                setLoadingState(false);
            });
    }

    function loadDemo() {
        loadFromUrl(DEMO_URL);
    }

    // Event listeners
    elements.fileInput.addEventListener('change', function (e) {
        var files = Array.from(e.target.files);
        if (files.length === 0 || state.isProcessing) return;

        setLoadingState(true);
        updateProgressBar(0, 'Starting...');

        var processed = 0;
        var newTraces = [];
        var totalFiles = files.length;

        files.forEach(function (file, index) {
            var reader = new FileReader();

            reader.onprogress = function (e) {
                if (e.lengthComputable) {
                    var fileProgress = (e.loaded / e.total) * 100;
                    var overallProgress = ((processed * 100) + fileProgress) / totalFiles;
                    updateProgressBar(overallProgress, 'Processing ' + file.name + '...');
                }
            };

            reader.onload = function (e) {
                var traces = parseJSONL(e.target.result, file.name);
                newTraces = newTraces.concat(traces);
                processed++;

                var progress = (processed / totalFiles) * 100;
                updateProgressBar(progress, processed === totalFiles ? 'Completing...' : 'Processing file ' + (processed + 1) + '...');

                if (processed === totalFiles) {
                    setTimeout(function () {
                        state.traces = state.traces.concat(newTraces);
                        state.traces.sort(function (a, b) {
                            return b.endTime - a.endTime;
                        });
                        updateStats();
                        renderTraceList();
                        showNotification('✅ Loaded ' + newTraces.length + ' traces from ' + files.length + ' files');
                        updateProgressBar(-1);
                        setLoadingState(false);
                    }, 200);
                }
            };

            reader.readAsText(file);
        });
    });

    elements.searchInput.addEventListener('input', renderTraceList);
    elements.expandAllBtn.addEventListener('click', toggleExpandAll);
    elements.clearAllBtn.addEventListener('click', clearAll);
    elements.loadUrlBtn.addEventListener('click', function () {
        loadFromUrl();
    });
    elements.demoBtn.addEventListener('click', loadDemo);

    elements.urlInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            loadFromUrl();
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function (e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'c' && state.hoveredSpan) {
            e.preventDefault();
            copySpanData();
        }
    });

    // Check for URL parameter on load
    var urlParams = new URLSearchParams(window.location.search);
    var urlParam = urlParams.get('url');
    if (urlParam) {
        elements.urlInput.value = urlParam;
        loadFromUrl();
    }

    window.addEventListener('resize', function () {
        if (state.selectedTrace) {
            setTimeout(renderTimelineAxis, 100);
        }
    });

    updateStats();
</script>
</body>
</html>