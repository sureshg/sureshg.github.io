<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Trace Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #fafbfc;
            --bg-tertiary: #f6f8fa;
            --bg-hover: #f0f2f5;
            --bg-accent: #e7f2ff;
            --border: #d0d7de;
            --border-light: #e5e9ed;
            --text-primary: #1f2328;
            --text-secondary: #57606a;
            --text-muted: #8c959f;
            --accent: #0969da;
            --accent-hover: #0550ae;
            --success: #1a7f37;
            --success-hover: #116329;
            --danger: #cf222e;
            --danger-hover: #a40e26;
            --warning: #bf8700;
            --purple: #8250df;
            --pink: #d5168a;
            --orange: #fb8500;
            --teal: #00a67e;
            --indigo: #5e60ce;
            --selected: #ddf4ff;
            --selected-border: #54aeff;
            --highlight: #fff8c5;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.15);
        }

        [data-theme="dark"] {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #1c2128;
            --bg-hover: #21262d;
            --bg-accent: #152642;
            --border: #30363d;
            --border-light: #21262d;
            --text-primary: #e6edf3;
            --text-secondary: #8d96a0;
            --text-muted: #636c76;
            --accent: #4493f8;
            --accent-hover: #539bf5;
            --success: #3fb950;
            --success-hover: #4ac65e;
            --danger: #f85149;
            --danger-hover: #ff6b6b;
            --warning: #d29922;
            --purple: #bc8cff;
            --pink: #f778ba;
            --orange: #fb8500;
            --teal: #39d0aa;
            --indigo: #7d8afa;
            --selected: #1c2d41;
            --selected-border: #4493f8;
            --highlight: #4a3b11;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
            --shadow: 0 2px 4px rgba(0,0,0,0.5);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.7);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-primary);
            background: var(--bg-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: background-color 0.2s, color 0.2s;
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
            flex-wrap: wrap;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            padding: 6px 12px;
            transition: all 0.15s;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover:not(:disabled) {
            background: var(--bg-hover);
            border-color: var(--accent);
        }

        .btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--accent-hover);
        }

        .btn-success {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }

        .btn-sm {
            font-size: 12px;
            padding: 4px 10px;
        }

        .input {
            padding: 6px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 13px;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.15s;
        }

        .input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--bg-accent);
        }

        .url-input {
            flex: 1;
            min-width: 200px;
            max-width: 400px;
        }

        .stats {
            display: flex;
            gap: 12px;
            font-size: 13px;
            margin-left: auto;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-weight: 500;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--accent);
        }

        .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .main {
            display: flex;
            flex: 1;
            min-height: 0;
        }

        .sidebar {
            width: 360px;
            border-right: 1px solid var(--border);
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .search-box {
            display: flex;
            gap: 6px;
        }

        .search-input {
            flex: 1;
            padding-left: 32px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23636c76" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>');
            background-repeat: no-repeat;
            background-position: 8px center;
        }

        .search-nav-btn {
            width: 32px;
            height: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .search-info {
            font-size: 11px;
            color: var(--text-muted);
            text-align: center;
        }

        .trace-list {
            flex: 1;
            overflow-y: auto;
            padding: 4px;
        }

        .trace-item {
            background: var(--bg-primary);
            border-left: 3px solid transparent;
            border-radius: 6px;
            padding: 10px 40px 10px 12px;
            margin: 2px 4px;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .trace-item:hover {
            background: var(--bg-hover);
            border-left-color: var(--accent);
        }

        .trace-item.selected {
            border-left-color: var(--accent);
            background: var(--selected);
            font-weight: 600;
        }

        .trace-item.highlight {
            background: var(--bg-accent);
            border-left-color: var(--accent);
        }

        .trace-icon {
            flex-shrink: 0;
            width: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
        }

        .trace-content {
            flex: 1;
            min-width: 0;
        }

        .trace-close {
            width: 20px;
            height: 20px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-muted);
            opacity: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.15s;
            flex-shrink: 0;
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
        }

        .trace-item:hover .trace-close {
            opacity: 1;
        }

        .trace-close:hover {
            background: var(--danger);
            color: white;
        }

        .trace-name {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 3px;
            font-size: 13px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .trace-item.selected .trace-name {
            font-weight: 600;
        }

        .trace-id {
            font-family: ui-monospace, "SF Mono", Monaco, monospace;
            font-size: 10px;
            color: var(--text-muted);
            margin-bottom: 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .trace-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: var(--text-secondary);
            gap: 8px;
        }

        .trace-duration {
            font-weight: 600;
            color: var(--purple);
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .content-header {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .trace-info {
            flex: 1;
            min-width: 0;
        }

        .trace-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .trace-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .controls {
            display: flex;
            gap: 8px;
        }

        .timeline-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .timeline-header {
            height: 38px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
            display: grid;
            grid-template-columns: 450px 1fr;
            align-items: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .timeline-header-left {
            padding: 0 12px;
            border-right: 1px solid var(--border);
        }

        .timeline-axis {
            position: relative;
            height: 100%;
            padding: 0 16px;
        }

        .axis-tick {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 1px;
            background: var(--border-light);
        }

        .axis-label {
            position: absolute;
            bottom: 8px;
            font-size: 10px;
            transform: translateX(-50%);
            color: var(--text-muted);
            font-weight: 500;
        }

        .timeline-body {
            flex: 1;
            overflow-y: auto;
        }

        .span-row {
            display: grid;
            grid-template-columns: 450px 1fr;
            min-height: 40px;
            border-bottom: 1px solid var(--border-light);
            transition: background 0.1s;
        }

        .span-row:hover {
            background: var(--bg-secondary);
        }

        .span-row.highlight {
            background: var(--selected) !important;
            border-left: 3px solid var(--selected-border);
            box-shadow: inset 0 0 0 1px var(--selected-border);
        }

        @keyframes fadeHighlight {
            0% { background: var(--accent); }
            100% { background: transparent; }
        }

        .span-row.flash {
            animation: fadeHighlight 1s ease-out;
        }

        .span-label {
            padding: 8px 12px;
            display: flex;
            align-items: flex-start;
            gap: 6px;
            border-right: 1px solid var(--border);
            background: var(--bg-primary);
        }

        .span-expand-area {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
            min-width: 0;
        }

        .span-main {
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 0;
        }

        .expand-btn {
            width: 20px;
            height: 20px;
            border: none;
            background: none;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 14px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.15s;
        }

        .expand-btn:hover {
            background: var(--bg-hover);
            color: var(--accent);
        }

        .span-info {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-width: 0;
            gap: 8px;
        }

        .span-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 13px;
            cursor: pointer;
            transition: color 0.15s;
        }

        .span-name:hover {
            color: var(--accent);
            text-decoration: underline;
        }

        .span-duration-label {
            font-size: 11px;
            font-family: ui-monospace, monospace;
            font-weight: 600;
            color: var(--purple);
            flex-shrink: 0;
        }

        .span-attributes {
            margin-left: 26px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 11px;
            border-left: 2px solid var(--border);
        }

        .attr-row {
            display: flex;
            gap: 8px;
            margin-bottom: 4px;
            align-items: flex-start;
        }

        .attr-row:last-child {
            margin-bottom: 0;
        }

        .attr-key {
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 100px;
            font-family: ui-monospace, monospace;
        }

        .attr-value {
            color: var(--text-primary);
            font-family: ui-monospace, monospace;
            word-break: break-word;
        }

        .span-timeline {
            position: relative;
            padding: 10px 16px;
        }

        .span-bar {
            height: 20px;
            border-radius: 6px;
            cursor: pointer;
            position: absolute;
            top: 10px;
            display: flex;
            align-items: center;
            color: white;
            font-size: 10px;
            font-weight: 600;
            overflow: hidden;
            transition: all 0.15s;
            min-width: 2px;
            box-shadow: var(--shadow-sm);
        }

        .span-bar:hover {
            filter: brightness(1.2);
            box-shadow: var(--shadow);
            z-index: 10;
            transform: scaleY(1.1);
        }

        .span-duration-text {
            padding: 0 8px;
            white-space: nowrap;
            opacity: 0.95;
        }

        .tooltip {
            position: fixed;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 8px;
            font-size: 12px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            z-index: 2000;
            pointer-events: auto;
            width: 600px;
            max-height: 85vh;
            overflow: hidden;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            cursor: move;
            resize: both;
            min-width: 400px;
            min-height: 300px;
        }

        .tooltip-tabs {
            display: flex;
            gap: 2px;
            padding: 8px 8px 0 8px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-tertiary);
        }

        .tooltip-tab {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            border-radius: 6px 6px 0 0;
            transition: all 0.15s;
        }

        .tooltip-tab:hover {
            background: var(--bg-hover);
        }

        .tooltip-tab.active {
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-weight: 600;
        }

        .tooltip-content {
            padding: 12px;
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
            cursor: auto;
        }

        .attr-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 8px;
            padding: 6px 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            transition: background 0.15s;
        }

        .attr-item:hover {
            background: var(--bg-hover);
        }

        .attr-item-content {
            flex: 1;
            min-width: 0;
        }

        .attr-copy-btn {
            width: 24px;
            height: 24px;
            padding: 0;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 14px;
            transition: all 0.15s;
        }

        .attr-copy-btn:hover {
            background: var(--accent);
            color: white;
        }

        .tooltip-panel {
            display: none;
        }

        .tooltip-panel.active {
            display: block;
        }

        .tooltip-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .tooltip-row svg {
            flex-shrink: 0;
        }

        .tooltip-row:last-child {
            margin-bottom: 0;
        }

        .tooltip-label {
            font-weight: 600;
            min-width: 80px;
            color: var(--text-secondary);
        }

        .tooltip-value {
            font-family: ui-monospace, monospace;
            background: var(--bg-secondary);
            padding: 2px 6px;
            border-radius: 4px;
            word-break: break-all;
        }

        .tooltip-hint {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border-light);
            font-size: 11px;
            color: var(--text-muted);
        }

        .tooltip-close {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border: none;
            background: var(--bg-hover);
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .tooltip-close:hover {
            background: var(--danger);
            color: white;
        }

        .attr-list {
            margin-top: 8px;
        }

        .attr-header {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            flex-direction: column;
            gap: 12px;
            color: var(--text-muted);
        }

        .empty-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .empty-text {
            font-size: 16px;
            font-weight: 600;
        }

        .empty-hint {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .hidden {
            display: none !important;
        }

        input[type="file"] {
            display: none;
        }

        .depth-0 { background: #6366f1; }
        .depth-1 { background: #ec4899; }
        .depth-2 { background: #3b82f6; }
        .depth-3 { background: #10b981; }
        .depth-4 { background: #f59e0b; }
        .depth-5 { background: #8b5cf6; }
        .depth-6 { background: #06b6d4; }
        .depth-7 { background: #f97316; }
        .depth-8 { background: #a855f7; }
        .depth-9 { background: #14b8a6; }
        .depth-default { background: #6b7280; }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 14px 18px;
            border-radius: 8px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            z-index: 3000;
            animation: slideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-width: 350px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            font-weight: 500;
        }

        .notification.success {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .notification.error {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        @keyframes slideUp {
            from {
                transform: translateY(calc(100% + 40px));
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .footer {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 10px 20px;
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
            flex-shrink: 0;
        }

        .footer a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .share-btn {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        @media (max-width: 1024px) {
            .timeline-header {
                grid-template-columns: 300px 1fr;
            }
            .span-row {
                grid-template-columns: 300px 1fr;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 10px;
                gap: 8px;
            }

            .header h1 {
                font-size: 18px;
                width: 100%;
            }

            .url-input {
                width: 100%;
                max-width: 100%;
            }

            .stats {
                width: 100%;
                justify-content: space-around;
                font-size: 12px;
                margin-left: 0;
            }

            .main {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-height: 40vh;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }

            .content-header {
                flex-direction: column;
                align-items: stretch;
            }

            .controls {
                justify-content: space-between;
            }

            .timeline-header {
                grid-template-columns: 180px 1fr;
            }

            .span-row {
                grid-template-columns: 180px 1fr;
                min-height: 36px;
            }

            .span-attributes {
                margin-left: 10px;
                padding: 6px 10px;
            }

            .attr-key {
                min-width: 80px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 16px;
            }

            .btn {
                font-size: 12px;
                padding: 5px 10px;
            }

            .timeline-header {
                grid-template-columns: 140px 1fr;
            }

            .span-row {
                grid-template-columns: 140px 1fr;
            }
        }
    </style>
</head>
<body>
<div class="header">
    <h1>
        <span>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
            </svg>
        </span>
        <span>Trace Viewer</span>
    </h1>
    <label for="file-input" class="btn btn-primary">
        <span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
        </span>
        <span>Upload</span>
    </label>
    <input type="file" id="file-input" accept=".jsonl,.json" multiple>
    <button class="btn" id="demo-btn">
        <span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
            </svg>
        </span>
        <span>Demo</span>
    </button>
    <input type="text" class="input url-input" id="url-input" placeholder="Enter URL or GitHub Gist...">
    <button class="btn" id="load-url-btn">
        <span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
            </svg>
        </span>
        <span>Load</span>
    </button>
    <div class="stats">
        <span id="loading-status" class="loading hidden">
            <div class="spinner"></div>
            <span>Loading...</span>
        </span>
        <div class="stat-item">
            <span>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                </svg>
            </span>
            <span id="trace-count">0</span>
        </div>
        <div class="stat-item">
            <span>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                </svg>
            </span>
            <span id="span-count">0</span>
        </div>
    </div>
    <button class="btn" onclick="toggleTheme()" title="Toggle theme">
        <span id="theme-icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
        </span>
    </button>
</div>

<div class="main">
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="search-box">
                <input type="text" class="input search-input" id="search" placeholder="Search traces and spans...">
                <button class="btn search-nav-btn" id="search-prev" title="Previous result">&lt;</button>
                <button class="btn search-nav-btn" id="search-next" title="Next result">&gt;</button>
            </div>
            <div class="search-info" id="search-info"></div>
        </div>
        <div class="trace-list" id="trace-list">
            <div class="empty-state">
                <div class="empty-icon">
                    <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.5">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    </svg>
                </div>
                <div class="empty-text">No traces loaded</div>
                <div class="empty-hint">Upload files, load URL, or try demo</div>
            </div>
        </div>
    </div>

    <div class="content">
        <div class="content-header">
            <div class="trace-info">
                <div class="trace-title" id="trace-title">Select a trace</div>
                <div class="trace-subtitle" id="trace-subtitle"></div>
            </div>
            <div class="controls">
                <button class="btn btn-sm" id="expand-btn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                    <span>Collapse</span>
                </button>
                <button class="btn btn-sm" id="share-btn" title="Copy shareable link">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="18" cy="5" r="3"></circle>
                        <circle cx="6" cy="12" r="3"></circle>
                        <circle cx="18" cy="19" r="3"></circle>
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                    </svg>
                    <span>Share</span>
                </button>
                <button class="btn btn-sm btn-danger" id="clear-btn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    <span>Clear</span>
                </button>
            </div>
        </div>
        <div class="timeline-container">
            <div class="timeline-header">
                <div class="timeline-header-left">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                        <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                        <line x1="7" y1="7" x2="7.01" y2="7"></line>
                    </svg>
                    Span Name & Duration
                </div>
                <div class="timeline-axis" id="timeline-axis"></div>
            </div>
            <div class="timeline-body" id="timeline">
                <div class="empty-state">
                    <div class="empty-icon">
                        <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.5">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                        </svg>
                    </div>
                    <div class="empty-text">No trace selected</div>
                    <div class="empty-hint">Select a trace to view timeline</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="footer">
    <div>
        Built with
        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" stroke="none" style="vertical-align: middle; color: var(--danger);">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
        </svg>
        for <a href="https://github.com/JetBrains/amper" target="_blank" rel="noopener">Kotlin Amper</a> Build Traces •
        <a href="https://suresh.dev" target="_blank" rel="noopener">suresh.dev</a>
    </div>
</div>

<div class="tooltip hidden" id="tooltip"></div>

<script>
    const DEMO_URL = 'https://gist.githubusercontent.com/sureshg/c0f0abd0a96b663000b18ca11d657fe9/raw';

    const state = {
        traces: [],
        selected: null,
        expanded: true,
        processing: false,
        expandedSpans: new Set(),
        searchResults: [],
        searchIndex: 0
    };

    const el = {
        fileInput: document.getElementById('file-input'),
        demoBtn: document.getElementById('demo-btn'),
        urlInput: document.getElementById('url-input'),
        loadUrlBtn: document.getElementById('load-url-btn'),
        loadingStatus: document.getElementById('loading-status'),
        expandBtn: document.getElementById('expand-btn'),
        shareBtn: document.getElementById('share-btn'),
        clearBtn: document.getElementById('clear-btn'),
        search: document.getElementById('search'),
        searchInfo: document.getElementById('search-info'),
        searchPrev: document.getElementById('search-prev'),
        searchNext: document.getElementById('search-next'),
        traceList: document.getElementById('trace-list'),
        traceTitle: document.getElementById('trace-title'),
        traceSubtitle: document.getElementById('trace-subtitle'),
        timeline: document.getElementById('timeline'),
        timelineAxis: document.getElementById('timeline-axis'),
        tooltip: document.getElementById('tooltip'),
        traceCount: document.getElementById('trace-count'),
        spanCount: document.getElementById('span-count')
    };

    function toggleTheme() {
        const body = document.documentElement;
        const icon = document.getElementById('theme-icon');
        const isDark = body.getAttribute('data-theme') === 'dark';

        body.setAttribute('data-theme', isDark ? '' : 'dark');
        icon.innerHTML = isDark
            ? `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
               </svg>`
            : `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
               </svg>`;
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
    }

    function initTheme() {
        const saved = localStorage.getItem('theme');
        const theme = saved || 'dark';
        if (theme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.getElementById('theme-icon').textContent = '☀️';
        }
        if (!saved) {
            localStorage.setItem('theme', 'dark');
        }
    }

    function formatDuration(nanos) {
        if (!nanos) return '0ms';
        const ms = nanos / 1e6;
        if (ms < 1) return `${(nanos / 1e3).toFixed(0)}μs`;
        if (ms < 1000) return `${ms.toFixed(0)}ms`;
        if (ms < 60000) return `${(ms / 1000).toFixed(2)}s`;
        const m = Math.floor(ms / 60000);
        const s = ((ms % 60000) / 1000).toFixed(0);
        return `${m}m ${s}s`;
    }

    function formatTime(nanos) {
        return new Date(Math.floor(nanos / 1e6)).toLocaleString();
    }

    function setLoading(loading) {
        state.processing = loading;
        el.loadingStatus.classList.toggle('hidden', !loading);
        el.fileInput.disabled = loading;
        el.demoBtn.disabled = loading;
        el.loadUrlBtn.disabled = loading;
        el.urlInput.disabled = loading;
    }

    function notify(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        const icon = type === 'success'
            ? `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                   <polyline points="20 6 9 17 4 12"></polyline>
               </svg>`
            : `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                   <circle cx="12" cy="12" r="10"></circle>
                   <line x1="15" y1="9" x2="9" y2="15"></line>
                   <line x1="9" y1="9" x2="15" y2="15"></line>
               </svg>`;
        notification.innerHTML = `${icon}<span>${message}</span>`;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }

    function parseJSONL(text, source) {
        const lines = text.trim().split('\n').filter(l => l.trim());
        const spans = [];

        lines.forEach((line, i) => {
            try {
                const data = JSON.parse(line);
                if (!data.resourceSpans) return;

                data.resourceSpans.forEach(rs => {
                    let service = 'unknown';
                    rs.resource?.attributes?.forEach(attr => {
                        if (attr.key === 'service.name' && attr.value?.stringValue) {
                            service = attr.value.stringValue;
                        }
                    });

                    (rs.scopeSpans || []).forEach(ss => {
                        (ss.spans || []).forEach(span => {
                            const startTime = parseInt(span.startTimeUnixNano || 0);
                            const endTime = parseInt(span.endTimeUnixNano || 0);

                            const attributes = {};
                            if (span.attributes) {
                                span.attributes.forEach(attr => {
                                    const value = attr.value?.stringValue ||
                                                 attr.value?.intValue ||
                                                 attr.value?.doubleValue ||
                                                 attr.value?.boolValue ||
                                                 JSON.stringify(attr.value);
                                    attributes[attr.key] = value;
                                });
                            }

                            spans.push({
                                traceId: span.traceId,
                                spanId: span.spanId,
                                parentSpanId: span.parentSpanId || null,
                                name: span.name || 'unnamed',
                                service,
                                startTime,
                                endTime,
                                duration: endTime - startTime,
                                attributes,
                                children: [],
                                expanded: true,
                                depth: 0,
                                source
                            });
                        });
                    });
                });
            } catch (e) {
                console.warn(`Parse error on line ${i + 1}:`, e);
            }
        });

        return buildTraces(spans);
    }

    function buildTraces(spans) {
        const traceMap = {};
        spans.forEach(span => {
            if (!traceMap[span.traceId]) traceMap[span.traceId] = [];
            traceMap[span.traceId].push(span);
        });

        const traces = [];
        Object.keys(traceMap).forEach(traceId => {
            const traceSpans = traceMap[traceId];
            const spanMap = {};
            const rootSpans = [];

            traceSpans.forEach(span => spanMap[span.spanId] = span);

            traceSpans.forEach(span => {
                if (span.parentSpanId && spanMap[span.parentSpanId]) {
                    spanMap[span.parentSpanId].children.push(span);
                } else {
                    rootSpans.push(span);
                }
            });

            function setDepth(spans, depth) {
                spans.sort((a, b) => a.startTime - b.startTime);
                spans.forEach(span => {
                    span.depth = depth;
                    if (span.children.length > 0) setDepth(span.children, depth + 1);
                });
            }

            setDepth(rootSpans, 0);

            const startTime = Math.min(...traceSpans.map(s => s.startTime));
            const endTime = Math.max(...traceSpans.map(s => s.endTime));

            const mainSpan = rootSpans[0];
            const name = mainSpan
                ? (mainSpan.name.startsWith('task :') ? mainSpan.name : `${traceSpans[0].service}: ${mainSpan.name}`)
                : `Trace ${traceId.substring(0, 8)}`;

            traces.push({
                traceId,
                spans: traceSpans,
                rootSpans,
                startTime,
                endTime,
                duration: endTime - startTime,
                service: traceSpans[0]?.service || 'unknown',
                name,
                source: traceSpans[0]?.source
            });
        });

        traces.sort((a, b) => b.endTime - a.endTime);
        return traces;
    }

    function performSearch(term) {
        if (!term) {
            state.searchResults = [];
            state.searchIndex = 0;
            el.searchInfo.textContent = '';
            el.searchPrev.disabled = true;
            el.searchNext.disabled = true;
            return;
        }

        const results = [];

        // Depth-first search through traces and spans
        function searchSpansDepthFirst(spans, trace) {
            spans.forEach(span => {
                const spanMatches = span.name.toLowerCase().includes(term) ||
                                   span.spanId.toLowerCase().includes(term) ||
                                   Object.values(span.attributes).some(v =>
                                       String(v).toLowerCase().includes(term));

                if (spanMatches) {
                    results.push({ trace, span });
                }

                // Recursively search children (depth-first)
                if (span.children && span.children.length > 0) {
                    searchSpansDepthFirst(span.children, trace);
                }
            });
        }

        state.traces.forEach(trace => {
            const traceMatches = trace.name.toLowerCase().includes(term) ||
                                trace.traceId.toLowerCase().includes(term);

            if (traceMatches) {
                results.push({ trace, span: null });
            }

            // Search through root spans depth-first
            searchSpansDepthFirst(trace.rootSpans, trace);
        });

        state.searchResults = results;
        state.searchIndex = 0;
        updateSearchInfo();

        return results;
    }

    function updateSearchInfo() {
        const total = state.searchResults.length;
        if (total === 0) {
            el.searchInfo.textContent = 'No results found';
            el.searchPrev.disabled = true;
            el.searchNext.disabled = true;
        } else {
            el.searchInfo.textContent = `${state.searchIndex + 1} of ${total} result${total > 1 ? 's' : ''}`;
            el.searchPrev.disabled = state.searchIndex === 0;
            el.searchNext.disabled = state.searchIndex >= total - 1;
        }
    }

    function navigateSearch(direction) {
        if (state.searchResults.length === 0) return;

        // Clear highlights immediately before changing index
        document.querySelectorAll('.span-row').forEach(row => {
            row.classList.remove('highlight');
        });

        const newIndex = state.searchIndex + direction;
        if (newIndex < 0 || newIndex >= state.searchResults.length) return;

        state.searchIndex = newIndex;
        const result = state.searchResults[state.searchIndex];

        if (result.trace.traceId !== state.selected?.traceId) {
            selectTrace(result.trace.traceId);
            if (result.span) {
                setTimeout(() => {
                    scrollToSpan(result.span.spanId, false, false);
                    highlightSearchResults();
                }, 100);
            }
        } else if (result.span) {
            scrollToSpan(result.span.spanId, false, false);
            highlightSearchResults();
        }

        updateSearchInfo();
    }

    function highlightSearchResults() {
        const term = el.search.value.toLowerCase().trim();

        document.querySelectorAll('.trace-item').forEach(item => {
            item.classList.remove('highlight');
        });

        document.querySelectorAll('.span-row').forEach(row => {
            row.classList.remove('highlight');
        });

        if (!term || state.searchResults.length === 0) return;

        // Only highlight the current search result
        const currentResult = state.searchResults[state.searchIndex];
        if (currentResult && currentResult.trace.traceId === state.selected?.traceId && currentResult.span) {
            const spanRow = document.querySelector(`[data-span-id="${currentResult.span.spanId}"]`);
            if (spanRow) {
                spanRow.classList.add('highlight');
            }
        }
    }

    function scrollToSpan(spanId, updateUrl = false, flash = true) {
        // Clear all flash animations first
        document.querySelectorAll('.span-row').forEach(row => {
            row.classList.remove('flash');
        });

        const spanRow = document.querySelector(`[data-span-id="${spanId}"]`);
        if (spanRow) {
            spanRow.scrollIntoView({ behavior: 'auto', block: 'nearest' });

            if (flash) {
                // Use setTimeout to ensure the class is removed before re-adding
                setTimeout(() => {
                    spanRow.classList.add('flash');
                    setTimeout(() => spanRow.classList.remove('flash'), 1200);
                }, 50);
            }
            if (updateUrl) updateURL(spanId);
        }
    }

    function renderTraceList() {
        if (state.traces.length === 0) {
            el.traceList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.5">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                        </svg>
                    </div>
                    <div class="empty-text">No traces loaded</div>
                    <div class="empty-hint">Upload files, load URL, or try demo</div>
                </div>`;
            return;
        }

        const term = el.search.value.toLowerCase().trim();
        let filtered = state.traces;

        if (term) {
            const results = performSearch(term);
            const traceIds = new Set(results.map(r => r.trace.traceId));
            filtered = state.traces.filter(t => traceIds.has(t.traceId));
        }

        el.traceList.innerHTML = filtered.map(trace => {
            const selected = state.selected?.traceId === trace.traceId;
            const hasResults = term && state.searchResults.some(r => r.trace.traceId === trace.traceId);
            return `
                <div class="trace-item ${selected ? 'selected' : ''} ${hasResults && !selected ? 'highlight' : ''}"
                     onclick="selectTrace('${trace.traceId}')">
                    <div class="trace-icon">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                        </svg>
                    </div>
                    <div class="trace-content">
                        <div class="trace-name">${trace.name}</div>
                        <div class="trace-id">${trace.traceId}</div>
                        <div class="trace-meta">
                            <span>
                                <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 2px;">
                                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                                </svg>
                                ${trace.spans.length}
                            </span>
                            <span class="trace-duration">
                                <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 2px;">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                                ${formatDuration(trace.duration)}
                            </span>
                        </div>
                    </div>
                    <button class="trace-close" onclick="removeTrace(event, '${trace.traceId}')">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>`;
        }).join('');
    }

    function selectTrace(traceId) {
        state.selected = state.traces.find(t => t.traceId === traceId);
        updateURL();
        renderTraceList();
        renderTimeline();
        highlightSearchResults();
    }

    function removeTrace(event, traceId) {
        event.stopPropagation();
        state.traces = state.traces.filter(t => t.traceId !== traceId);

        if (state.selected?.traceId === traceId) {
            state.selected = null;
            updateURL();
            el.timeline.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.5">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                        </svg>
                    </div>
                    <div class="empty-text">No trace selected</div>
                    <div class="empty-hint">Select a trace to view timeline</div>
                </div>`;
            el.traceTitle.textContent = 'Select a trace';
            el.traceSubtitle.textContent = '';
        }

        updateStats();
        renderTraceList();
    }

    function flattenSpans(spans) {
        const result = [];
        function traverse(spans) {
            spans.forEach(span => {
                result.push(span);
                if (span.expanded && span.children.length > 0) {
                    traverse(span.children);
                }
            });
        }
        traverse(spans);
        return result;
    }

    function renderTimelineAxis() {
        if (!state.selected) return;

        el.timelineAxis.innerHTML = '';
        const duration = state.selected.duration;
        const width = el.timelineAxis.offsetWidth - 32;

        for (let i = 0; i <= 6; i++) {
            const pos = (i / 6) * width;
            const time = (i / 6) * duration;

            const tick = document.createElement('div');
            tick.className = 'axis-tick';
            tick.style.left = `${16 + pos}px`;

            const label = document.createElement('div');
            label.className = 'axis-label';
            label.style.left = `${16 + pos}px`;
            label.textContent = formatDuration(time);

            el.timelineAxis.appendChild(tick);
            el.timelineAxis.appendChild(label);
        }
    }

    function findSpanById(spans, spanId) {
        for (const span of spans) {
            if (span.spanId === spanId) return span;
            const found = findSpanById(span.children, spanId);
            if (found) return found;
        }
        return null;
    }

    function renderTimeline() {
        if (!state.selected) {
            el.timeline.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.5">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                        </svg>
                    </div>
                    <div class="empty-text">No trace selected</div>
                    <div class="empty-hint">Select a trace to view timeline</div>
                </div>`;
            return;
        }

        el.traceTitle.textContent = state.selected.name;
        el.traceSubtitle.innerHTML = `
            <span>
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                </svg>
                ${state.selected.spans.length} spans
            </span>
            <span>
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                ${formatDuration(state.selected.duration)}
            </span>
            <span>
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                ${formatTime(state.selected.startTime)}
            </span>
        `;

        renderTimelineAxis();

        const flat = flattenSpans(state.selected.rootSpans);
        const duration = state.selected.duration || 1;
        const start = state.selected.startTime;

        el.timeline.innerHTML = flat.map(span => {
            const relStart = span.startTime - start;
            const left = Math.max(0, (relStart / duration) * 100);
            const width = Math.max(0.2, (span.duration / duration) * 100);

            const hasChildren = span.children.length > 0;
            const icon = hasChildren ? (span.expanded ? '▾' : '▸') : '●';
            const depthClass = span.depth <= 9 ? `depth-${span.depth}` : 'depth-default';
            const durationText = formatDuration(span.duration);
            const showDuration = width > 8;

            let html = `
                <div class="span-row" data-span-id="${span.spanId}">
                    <div class="span-label" style="padding-left: ${12 + span.depth * 16}px">
                        <div class="span-expand-area">
                            <div class="span-main">
                                <button class="expand-btn" onclick="toggleSpan(event, '${span.spanId}')"
                                        ${!hasChildren ? 'style="opacity:0.3"' : ''}>${icon}</button>
                                <div class="span-info">
                                    <div class="span-name" title="${span.name}" onclick="copySpanLink('${span.spanId}')">${span.name}</div>
                                    <div class="span-duration-label">${durationText}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="span-timeline">
                        <div class="span-bar ${depthClass}"
                             style="left: ${left}%; width: ${width}%"
                             onmouseenter="showTooltip(event, '${span.spanId}')"
                             onclick="copySpanLink('${span.spanId}')"
                             ondblclick="copySpan('${span.spanId}')">
                            ${showDuration ? `<span class="span-duration-text">${durationText}</span>` : ''}
                        </div>
                    </div>
                </div>`;

            return html;
        }).join('');

        highlightSearchResults();
    }

    function toggleSpan(event, spanId) {
        event.stopPropagation();

        function find(spans) {
            for (const span of spans) {
                if (span.spanId === spanId) {
                    if (span.children.length > 0) span.expanded = !span.expanded;
                    return true;
                }
                if (find(span.children)) return true;
            }
            return false;
        }

        if (state.selected) {
            find(state.selected.rootSpans);
            renderTimeline();
        }
    }

    function toggleExpandAll() {
        if (!state.selected) return;

        state.expanded = !state.expanded;
        el.expandBtn.innerHTML = state.expanded
            ? `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                   <polyline points="6 9 12 15 18 9"></polyline>
               </svg><span>Collapse</span>`
            : `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                   <polyline points="18 15 12 9 6 15"></polyline>
               </svg><span>Expand</span>`;

        function setExpanded(spans, expanded) {
            spans.forEach(span => {
                if (span.children.length > 0) {
                    span.expanded = expanded;
                    setExpanded(span.children, expanded);
                }
            });
        }

        setExpanded(state.selected.rootSpans, state.expanded);
        renderTimeline();
    }

    let tooltipTimeout = null;
    let tooltipVisible = false;
    let currentTooltipTab = 'info';

    function switchTooltipTab(tab) {
        currentTooltipTab = tab;
        document.querySelectorAll('.tooltip-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tooltip-panel').forEach(p => p.classList.remove('active'));
        document.querySelector(`.tooltip-tab[data-tab="${tab}"]`)?.classList.add('active');
        document.querySelector(`.tooltip-panel[data-panel="${tab}"]`)?.classList.add('active');
    }

    function showTooltip(event, spanId) {
        if (!state.selected) return;

        const span = state.selected.spans.find(s => s.spanId === spanId);
        if (!span) return;

        clearTimeout(tooltipTimeout);
        tooltipVisible = true;

        const relStart = span.startTime - state.selected.startTime;
        const attrs = Object.entries(span.attributes);
        const hasAttrs = attrs.length > 0;

        let html = `
            <div class="tooltip-tabs">
                <button class="tooltip-tab ${currentTooltipTab === 'info' ? 'active' : ''}" data-tab="info" onclick="switchTooltipTab('info')">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                    Info
                </button>
                ${hasAttrs ? `<button class="tooltip-tab ${currentTooltipTab === 'attrs' ? 'active' : ''}" data-tab="attrs" onclick="switchTooltipTab('attrs')">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                        <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                    </svg>
                    Attributes (${attrs.length})
                </button>` : ''}
                <button class="tooltip-close" onclick="hideTooltip()" style="margin-left: auto;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="tooltip-content">
                <div class="tooltip-panel ${currentTooltipTab === 'info' ? 'active' : ''}" data-panel="info">
                    <div class="tooltip-row">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                            <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                            <line x1="7" y1="7" x2="7.01" y2="7"></line>
                        </svg>
                        <span class="tooltip-label">Name:</span><span class="tooltip-value">${span.name}</span>
                    </div>
                    <div class="tooltip-row">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <span class="tooltip-label">Duration:</span><span class="tooltip-value">${formatDuration(span.duration)}</span>
                    </div>
                    <div class="tooltip-row">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                            <polyline points="9 11 12 14 22 4"></polyline>
                            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                        </svg>
                        <span class="tooltip-label">Start:</span><span class="tooltip-value">+${formatDuration(relStart)}</span>
                    </div>
                    <div class="tooltip-row">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                            <line x1="8" y1="21" x2="16" y2="21"></line>
                            <line x1="12" y1="17" x2="12" y2="21"></line>
                        </svg>
                        <span class="tooltip-label">Service:</span><span class="tooltip-value">${span.service}</span>
                    </div>
                    <div class="tooltip-row">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                        </svg>
                        <span class="tooltip-label">Span ID:</span><span class="tooltip-value">${span.spanId}</span>
                    </div>
                    <div class="tooltip-hint">Click span name to copy link • ESC or click outside to close</div>
                </div>`;

        if (hasAttrs) {
            html += `<div class="tooltip-panel ${currentTooltipTab === 'attrs' ? 'active' : ''}" data-panel="attrs">`;
            attrs.forEach(([key, value]) => {
                const valueStr = String(value);
                const attrId = `attr-${Math.random().toString(36).substr(2, 9)}`;
                html += `<div class="attr-item">
                    <div class="attr-item-content">
                        <div class="tooltip-row">
                            <span class="tooltip-label">${key}:</span>
                            <span class="tooltip-value" id="${attrId}" data-key="${key.replace(/"/g, '&quot;')}">${valueStr}</span>
                        </div>
                    </div>
                    <button class="attr-copy-btn" data-attr-id="${attrId}">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    </button>
                </div>`;
            });
            html += `</div>`;
        }

        html += `</div>`;

        el.tooltip.innerHTML = html;

        const x = Math.min(event.pageX + 12, window.innerWidth - 620);
        const y = Math.min(event.pageY + 12, window.innerHeight - 300);

        el.tooltip.style.left = `${x}px`;
        el.tooltip.style.top = `${y}px`;
        el.tooltip.classList.remove('hidden');

        // Add event listeners to copy buttons
        setTimeout(() => {
            document.querySelectorAll('.attr-copy-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const attrId = this.getAttribute('data-attr-id');
                    const attrEl = document.getElementById(attrId);
                    if (attrEl) {
                        const key = attrEl.getAttribute('data-key');
                        const value = attrEl.textContent;
                        if (navigator.clipboard) {
                            navigator.clipboard.writeText(value)
                                .then(() => notify(`Copied: ${key}`, 'success'))
                                .catch(() => notify('Failed to copy', 'error'));
                        } else {
                            notify('Clipboard not available', 'error');
                        }
                    }
                });
            });
        }, 10);
    }

    function hideTooltip() {
        tooltipVisible = false;
        clearTimeout(tooltipTimeout);
        tooltipTimeout = setTimeout(() => {
            if (!tooltipVisible) {
                el.tooltip.classList.add('hidden');
            }
        }, 100);
    }

    function keepTooltipVisible() {
        tooltipVisible = true;
        clearTimeout(tooltipTimeout);
    }

    window.copyAttrValue = function(key, value) {
        if (!navigator.clipboard) {
            notify('Clipboard not available', 'error');
            return;
        }
        navigator.clipboard.writeText(value)
            .then(() => notify(`Attribute value copied: ${key}`, 'success'))
            .catch(err => {
                console.error('Copy failed:', err);
                notify('Failed to copy attribute', 'error');
            });
    };

    // Make tooltip draggable
    let isDragging = false;
    let dragStartX = 0;
    let dragStartY = 0;
    let tooltipStartX = 0;
    let tooltipStartY = 0;

    function makeDraggable() {
        el.tooltip.addEventListener('mousedown', (e) => {
            if (e.target.closest('.tooltip-content') || e.target.closest('.tooltip-tab') || e.target.closest('.tooltip-close')) {
                return;
            }
            isDragging = true;
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            const rect = el.tooltip.getBoundingClientRect();
            tooltipStartX = rect.left;
            tooltipStartY = rect.top;
            el.tooltip.style.cursor = 'grabbing';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const dx = e.clientX - dragStartX;
            const dy = e.clientY - dragStartY;
            el.tooltip.style.left = `${tooltipStartX + dx}px`;
            el.tooltip.style.top = `${tooltipStartY + dy}px`;
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                el.tooltip.style.cursor = 'move';
            }
        });
    }

    function copySpanLink(spanId) {
        if (!state.selected) return;

        const url = new URL(window.location.href);
        url.searchParams.set('trace', state.selected.traceId);
        url.hash = `span-${spanId}`;

        navigator.clipboard?.writeText(url.toString())
            .then(() => notify('Span link copied!', 'success'))
            .catch(() => notify('Failed to copy link', 'error'));
    }

    function copySpan(spanId) {
        if (!state.selected) return;

        const span = state.selected.spans.find(s => s.spanId === spanId);
        if (!span) return;

        const relStart = span.startTime - state.selected.startTime;
        let text = `Name: ${span.name}\nDuration: ${formatDuration(span.duration)}\nStart: +${formatDuration(relStart)}\nService: ${span.service}\nSpan ID: ${span.spanId}\nTrace ID: ${span.traceId}`;

        if (Object.keys(span.attributes).length > 0) {
            text += '\n\nAttributes:\n' + Object.entries(span.attributes)
                .map(([k, v]) => `  ${k}: ${v}`)
                .join('\n');
        }

        navigator.clipboard?.writeText(text)
            .then(() => notify(`Copied span info`, 'success'))
            .catch(() => notify('Failed to copy', 'error'));
    }

    function shareTrace() {
        if (!state.selected) {
            notify('Select a trace first', 'error');
            return;
        }

        const url = new URL(window.location.href);
        url.searchParams.set('trace', state.selected.traceId);

        navigator.clipboard?.writeText(url.toString())
            .then(() => notify('Shareable link copied!', 'success'))
            .catch(() => notify('Failed to copy link', 'error'));
    }

    function updateURL(spanId = null) {
        const url = new URL(window.location.href);
        if (state.selected) {
            url.searchParams.set('trace', state.selected.traceId);
            if (spanId) {
                url.hash = `span-${spanId}`;
            } else {
                url.hash = '';
            }
        } else {
            url.searchParams.delete('trace');
            url.hash = '';
        }
        window.history.replaceState({}, '', url.toString());
    }

    function clearAll() {
        state.traces = [];
        state.selected = null;
        state.expanded = true;
        state.searchResults = [];
        el.urlInput.value = '';
        el.search.value = '';
        el.searchInfo.textContent = '';
        el.searchPrev.disabled = true;
        el.searchNext.disabled = true;
        updateURL();
        updateStats();
        renderTraceList();
        el.timeline.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">📈</div>
                <div class="empty-text">No trace selected</div>
                <div class="empty-hint">Select a trace to view timeline</div>
            </div>`;
        el.traceTitle.textContent = 'Select a trace';
        el.traceSubtitle.textContent = '';
        notify('All traces cleared', 'success');
    }

    function updateStats() {
        const totalSpans = state.traces.reduce((sum, t) => sum + t.spans.length, 0);
        el.traceCount.textContent = state.traces.length;
        el.spanCount.textContent = totalSpans;
    }

    function loadFromUrl(url) {
        const target = url || el.urlInput.value.trim();
        if (!target) {
            notify('Please enter a URL', 'error');
            return Promise.reject();
        }

        const isDemo = url === DEMO_URL;

        // Check if demo already loaded
        if (isDemo) {
            const hasDemoTraces = state.traces.some(t => t.source === 'Demo');
            if (hasDemoTraces) {
                notify('Demo already loaded', 'error');
                return Promise.resolve();
            }
        }

        let fetchUrl = target;
        const gistMatch = target.match(/gist\.github\.com\/(?:[\w-]+\/)?([a-f0-9]+)/);
        if (gistMatch) {
            fetchUrl = `https://gist.githubusercontent.com/${gistMatch[1]}/raw/`;
        }

        setLoading(true);
        return fetch(fetchUrl)
            .then(r => {
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                return r.text();
            })
            .then(text => {
                const newTraces = parseJSONL(text, isDemo ? 'Demo' : 'URL');
                if (newTraces.length === 0) {
                    notify('No valid traces found', 'error');
                    return;
                }

                state.traces = state.traces.concat(newTraces);
                state.traces.sort((a, b) => b.endTime - a.endTime);

                if (newTraces.length > 0 && !state.selected) {
                    state.selected = newTraces[0];
                    updateURL();
                    renderTimeline();
                }

                updateStats();
                renderTraceList();
                notify(`Loaded ${newTraces.length} trace${newTraces.length > 1 ? 's' : ''}`, 'success');
            })
            .catch(err => {
                notify(`Failed to load: ${err.message}`, 'error');
                throw err;
            })
            .finally(() => setLoading(false));
    }

    el.fileInput.addEventListener('change', e => {
        const files = Array.from(e.target.files);
        if (files.length === 0 || state.processing) return;

        setLoading(true);
        let newTraces = [];
        let processed = 0;

        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = e => {
                const traces = parseJSONL(e.target.result, file.name);
                newTraces = newTraces.concat(traces);
                processed++;

                if (processed === files.length) {
                    setTimeout(() => {
                        state.traces = state.traces.concat(newTraces);
                        state.traces.sort((a, b) => b.endTime - a.endTime);

                        if (newTraces.length > 0 && !state.selected) {
                            state.selected = newTraces[0];
                            updateURL();
                            renderTimeline();
                        }

                        updateStats();
                        renderTraceList();
                        notify(`Loaded ${newTraces.length} trace${newTraces.length > 1 ? 's' : ''} from ${files.length} file${files.length > 1 ? 's' : ''}`, 'success');
                        setLoading(false);
                    }, 100);
                }
            };
            reader.readAsText(file);
        });
    });

    el.search.addEventListener('input', () => {
        const term = el.search.value.toLowerCase().trim();
        if (term) {
            const results = performSearch(term);
            if (results.length > 0) {
                const firstResult = results[0];
                if (firstResult.trace.traceId !== state.selected?.traceId) {
                    selectTrace(firstResult.trace.traceId);
                    if (firstResult.span) {
                        setTimeout(() => scrollToSpan(firstResult.span.spanId, false, true), 300);
                    }
                } else if (firstResult.span) {
                    scrollToSpan(firstResult.span.spanId, false, true);
                }
            }
        } else {
            performSearch('');
        }
        renderTraceList();
        if (state.selected) {
            renderTimeline();
        }
    });

    el.searchPrev.addEventListener('click', () => navigateSearch(-1));
    el.searchNext.addEventListener('click', () => navigateSearch(1));

    el.expandBtn.addEventListener('click', toggleExpandAll);
    el.shareBtn.addEventListener('click', shareTrace);
    el.clearBtn.addEventListener('click', clearAll);
    el.loadUrlBtn.addEventListener('click', () => loadFromUrl());
    el.demoBtn.addEventListener('click', () => loadFromUrl(DEMO_URL));
    el.urlInput.addEventListener('keypress', e => {
        if (e.key === 'Enter') loadFromUrl();
    });

    window.addEventListener('resize', () => {
        if (state.selected) setTimeout(renderTimelineAxis, 100);
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') hideTooltip();
    });

    document.addEventListener('click', (e) => {
        if (!el.tooltip.classList.contains('hidden') &&
            !el.tooltip.contains(e.target) &&
            !e.target.closest('.span-bar')) {
            hideTooltip();
        }
    });

    el.tooltip.addEventListener('mouseenter', keepTooltipVisible);
    el.tooltip.addEventListener('mouseleave', hideTooltip);

    // Handle deep linking
    const urlParams = new URLSearchParams(window.location.search);
    const urlParam = urlParams.get('url');
    const traceParam = urlParams.get('trace');
    const spanHash = window.location.hash.match(/^#span-(.+)$/);
    const spanParam = spanHash ? spanHash[1] : null;

    if (urlParam) {
        el.urlInput.value = urlParam;
        loadFromUrl().then(() => {
            if (traceParam && state.traces.length > 0) {
                const trace = state.traces.find(t => t.traceId === traceParam);
                if (trace) {
                    selectTrace(trace.traceId);
                    if (spanParam) {
                        setTimeout(() => {
                            scrollToSpan(spanParam, false, true);
                        }, 300);
                    }
                }
            }
        });
    } else if (traceParam) {
        loadFromUrl(DEMO_URL).then(() => {
            const trace = state.traces.find(t => t.traceId === traceParam);
            if (trace) {
                selectTrace(trace.traceId);
                if (spanParam) {
                    setTimeout(() => {
                        scrollToSpan(spanParam, false, true);
                    }, 300);
                }
            }
        });
    }

    initTheme();
    updateStats();
    makeDraggable();
</script>
</body>
</html>
